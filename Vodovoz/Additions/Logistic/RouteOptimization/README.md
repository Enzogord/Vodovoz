# Описание механизма построение маршрутов
## Общие сведения
В этом файле находятся общеи сведения о механизме и что где находится. Более детальные описания конкретных классов, находятся в комментариях самих классов.

### Используемые библиотеки
Пожалуй главной библиотекой для оптимизации маршрутов является Google Optimization Tools (OR-Tools) (https://developers.google.com/optimization/) и (https://github.com/google/or-tools)
Эта библиотека позволяет проводить множество разных оптимизаций в том числе и решение [Vehicle Routing Problem (VRP)](https://en.wikipedia.org/wiki/Vehicle_routing_problem) и ее более сложные варианты такие как Vehicle routing problems with time windows.

Из-за того что нам нужна 32-х битная библиотека на винде, а разработчики распространяют только 64-битную версию, Библиотеку для виндовс мы собираем сами из исходников. Инструкция тут (lib/Google.OrTools/README.md).

Для рассчета расстояний мы используем отдельную службу установленную на сервере OSRM (http://project-osrm.org/), установлена она через Докер инструкция [здесь](https://github.com/QualitySolution/Vodovoz#Запустить-службу-рассчета-расстояний-osrm-на-сервере-можно-следующим-способом)

##Назначение классов и структура механизма

* Vodovoz/Vodovoz/Additions/Logistic/RouteOptimization - Расположение непосредственно самого механизма оптимизации маршрутов
  * RouteOptimizer - Главный класс опимизатора в нем настраиваются все параметры оптимизации маршрутов в статических полях. В нем существует 2 метода построение оптимальных маршрутов CreateRoutes и RebuidOneRoute. Фактически это единсвеныый класс с которым напрямую должен работать внешний код, остальные классы в этой папке являются вспомогательными или совсем внутренними.
  * CalculatedOrder - Класс для хранения адреса(заказа) с просчитанными на старте значениями, количества бутылей заказа, вес и объема заказа.
  * Callback* - Это классы обратных вызовов для рассчета величин, различных измерение. Классы AddressCount, Time, Volume, Weight - возвращаю значения соответсвующих измерения для каждого адреса. 
  * CallbackDistance - Возвращает расстояние между точками, расстояниня возвращаютсся без учета районов, и прочих штрафов. Сейчас не используется, оставлен для возможного дебага, в последствии можно будет удалить.
  * CallbackDistanceDistrict - Созвращает расстоянием между точками, с учетом всевозможных штрафов.
  * CallbackMonitor - Класс мониторинга за работой алгоритма, возможно не разобрался как правильно сделать, так как пришлось реализовывать 2 мониторинга. Может нужно сделать без наследования.
  * PossibleTrip - Класс с информацией о поездке(машруте). Это возможный будщей маршрут, На конкретного водителя и машину. Если машина и водитель едут второй раз, значит будет 2 таких класса, если у водителя 3 ходки, то должно быть создано 3 поездки.
  * ProposedRoute - Класс в котором механизм возвращает результат, то есть это предлогаемый оптимизатором маршрут.
* Vodovoz/VodovozBusiness/Tools/Logistic/ - Механизм рассчета расстояний, времени и геометрии маршрута между точками
  * DistanceCalculator - Простой класс считающий расстояние меду точками напрямую без учета дорожной сети.
  * ExtDistanceCalculator - Класс для массового рассчета матрицы расстояний между точками, с сохранением рассчитанных расстояний в базе данных в виде кеша. Класс работает с 2-я внешними сервисами Sputnik и OSRM. Загружает расстония в несколько потоков.
  * RouteGeometryCalculator - Класс тоже служит для получения расстояний. Но уже заточен на получения расстояний, времени и геометрии между точками на маршруте. Так же сохраняет расчитаные значения в кеш.
* Vodovoz/VodovozBusiness/Domain/Logistic/CachedDistance.cs - Класс непосредсвенно сохранения закешированного состояния в базе данных. Так же содержит кучу статических методов для работы с хешем координат.